<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Teste de Conex√£o Supabase - ADMAC</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
        background: #1a1a1a;
        color: #fff;
      }
      .container {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 16px;
        padding: 30px;
        border: 1px solid rgba(255, 215, 0, 0.3);
      }
      h1 {
        background: linear-gradient(135deg, #ffd700, #ffa500);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 30px;
      }
      .test-item {
        margin: 20px 0;
        padding: 15px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 8px;
        border-left: 4px solid #ffd700;
      }
      .test-title {
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 10px;
      }
      .test-result {
        margin-left: 20px;
        font-family: "Courier New", monospace;
        font-size: 0.9rem;
      }
      .success {
        color: #4caf50;
      }
      .error {
        color: #f44336;
      }
      .warning {
        color: #ffa500;
      }
      .info {
        color: #2196f3;
      }
      button {
        background: linear-gradient(135deg, #ffd700, #ffa500);
        color: #1a1a1a;
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        margin-top: 20px;
      }
      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(255, 215, 0, 0.3);
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 215, 0, 0.3);
        border-radius: 50%;
        border-top-color: #ffd700;
        animation: spin 1s ease-in-out infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîç Teste de Conex√£o Supabase</h1>

      <div id="results"></div>

      <button id="testBtn" onclick="runTests()">Executar Testes</button>
    </div>

    <script type="module">
      import {
        supabase,
        testSupabaseConnection,
      } from "./src/services/supabaseClient.js";

      window.runTests = async function () {
        const resultsDiv = document.getElementById("results");
        const testBtn = document.getElementById("testBtn");

        resultsDiv.innerHTML = "";
        testBtn.disabled = true;
        testBtn.innerHTML = '<span class="loading"></span> Testando...';

        // Test 1: Client initialization
        addTest("1Ô∏è‚É£ Verificando inicializa√ß√£o do cliente Supabase");
        if (supabase) {
          addResult("‚úÖ Cliente Supabase inicializado", "success");
          addResult(`üìç URL: ${supabase.supabaseUrl}`, "info");
        } else {
          addResult("‚ùå Cliente Supabase n√£o inicializado", "error");
          testBtn.disabled = false;
          testBtn.innerHTML = "Executar Testes";
          return;
        }

        // Test 2: Environment variables
        addTest("2Ô∏è‚É£ Verificando vari√°veis de ambiente");
        const anonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;
        if (anonKey && anonKey !== "your_anon_key_here") {
          addResult("‚úÖ VITE_SUPABASE_ANON_KEY configurada", "success");
          addResult(`üîë Chave: ${anonKey.substring(0, 30)}...`, "info");
        } else {
          addResult("‚ùå VITE_SUPABASE_ANON_KEY n√£o configurada", "error");
        }

        // Test 3: Connection test
        addTest("3Ô∏è‚É£ Testando conex√£o com Supabase");
        try {
          const isConnected = await testSupabaseConnection();

          if (isConnected) {
            addResult("‚úÖ Conectado ao Supabase com sucesso!", "success");
          } else {
            addResult(
              "‚ö†Ô∏è Teste de conex√£o falhou - tabelas podem n√£o existir",
              "warning"
            );
            addResult("üí° Execute o script SQL no Supabase SQL Editor", "info");
          }
        } catch (error) {
          addResult(`‚ùå Erro de conex√£o: ${error.message}`, "error");
        }

        // Test 4: Check tables
        addTest("4Ô∏è‚É£ Verificando exist√™ncia das tabelas");
        try {
          // Check activity_logs
          const { error: logsError } = await supabase
            .from("activity_logs")
            .select("count")
            .limit(1);

          if (!logsError) {
            addResult("‚úÖ Tabela activity_logs existe", "success");
          } else {
            addResult("‚ùå Tabela activity_logs n√£o encontrada", "error");
            addResult(`üí° Erro: ${logsError.message}`, "warning");
          }

          // Check active_sessions
          const { error: sessionsError } = await supabase
            .from("active_sessions")
            .select("count")
            .limit(1);

          if (!sessionsError) {
            addResult("‚úÖ Tabela active_sessions existe", "success");
          } else {
            addResult("‚ùå Tabela active_sessions n√£o encontrada", "error");
            addResult(`üí° Erro: ${sessionsError.message}`, "warning");
          }
        } catch (error) {
          addResult(`‚ùå Erro ao verificar tabelas: ${error.message}`, "error");
        }

        // Test 5: Write permissions
        addTest("5Ô∏è‚É£ Testando permiss√µes de escrita");
        try {
          const testRecord = {
            id: `test_${Date.now()}`,
            type: "login",
            user_email: "test@admac.com",
            user_name: "Test User",
            user_type: "admin",
            country: "Brasil",
            state: "S√£o Paulo",
            city: "S√£o Paulo",
            district: "Centro",
            browser: "Chrome",
            platform: "Win32",
            language: "pt-BR",
            timestamp: new Date().toISOString(),
            session_id: `test_session_${Date.now()}`,
          };

          const { data, error } = await supabase
            .from("activity_logs")
            .insert([testRecord])
            .select();

          if (!error) {
            addResult("‚úÖ Registro de teste inserido com sucesso", "success");
            addResult(`üìù ID do registro: ${data[0].id}`, "info");

            // Clean up
            await supabase
              .from("activity_logs")
              .delete()
              .eq("id", testRecord.id);
            addResult("üßπ Registro de teste removido", "success");
          } else {
            addResult("‚ùå Falha ao inserir registro de teste", "error");
            addResult(`üí° Erro: ${error.message}`, "warning");
          }
        } catch (error) {
          addResult(`‚ùå Erro no teste de escrita: ${error.message}`, "error");
        }

        // Final result
        addTest("üéâ Teste conclu√≠do!");
        testBtn.disabled = false;
        testBtn.innerHTML = "Executar Testes Novamente";
      };

      function addTest(title) {
        const resultsDiv = document.getElementById("results");
        const testItem = document.createElement("div");
        testItem.className = "test-item";
        testItem.innerHTML = `<div class="test-title">${title}</div><div class="test-result" id="result-${Date.now()}"></div>`;
        resultsDiv.appendChild(testItem);
        window.currentResultDiv = testItem.querySelector(".test-result");
      }

      function addResult(text, type = "info") {
        if (window.currentResultDiv) {
          const p = document.createElement("p");
          p.className = type;
          p.textContent = text;
          window.currentResultDiv.appendChild(p);
        }
      }

      // Auto-run on load
      window.addEventListener("load", () => {
        setTimeout(() => runTests(), 500);
      });
    </script>
  </body>
</html>
